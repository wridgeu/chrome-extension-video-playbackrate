name: create release

on:
  workflow_run:
    workflows: [Test]
    types: [completed]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: check if triggered by tag
        id: check-tag
        env:
          HEAD_REF: ${{ github.event.workflow_run.head_branch }}
        run: |
          TAG_EXISTS=$(git ls-remote --tags "https://github.com/${{ github.repository }}" "refs/tags/${HEAD_REF}" | wc -l)
          if [ "$TAG_EXISTS" -eq "0" ]; then
            echo "Workflow was triggered by branch push, not a tag. Skipping."
            echo "is_tag=false" >> "$GITHUB_OUTPUT"
          else
            echo "Workflow was triggered by tag: ${HEAD_REF}"
            echo "is_tag=true" >> "$GITHUB_OUTPUT"
            echo "tag=${HEAD_REF}" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
        if: steps.check-tag.outputs.is_tag == 'true'
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: verify tag is on default branch
        if: steps.check-tag.outputs.is_tag == 'true'
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          if ! git branch -a --contains "$COMMIT_SHA" | grep -qE "(^|\s)${DEFAULT_BRANCH}$|origin/${DEFAULT_BRANCH}$"; then
            echo "Error: Tag must be on default branch (${DEFAULT_BRANCH})"
            exit 1
          fi

      - uses: actions/setup-node@v4
        if: steps.check-tag.outputs.is_tag == 'true'
        with:
          node-version: 24.x
          cache: 'npm'

      - name: build
        if: steps.check-tag.outputs.is_tag == 'true'
        run: |
          npm ci
          npm run build
          npm run zip

      - name: create release
        if: steps.check-tag.outputs.is_tag == 'true'
        uses: ncipollo/release-action@v1
        with:
          artifacts: "*.dist.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ steps.check-tag.outputs.tag }}
