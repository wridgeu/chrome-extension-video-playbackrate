name: create release

on:
  workflow_run:
    workflows: [Test]
    types: [completed]

env:
  NODE_VERSION: 24.x

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_sha }}
        fetch-depth: 0

    - name: validate tag on default branch
      env:
        DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
      run: |
        TAG=$(git describe --tags --exact-match $COMMIT_SHA 2>/dev/null || true)
        if [ -z "$TAG" ]; then
          echo "No tag found for commit $COMMIT_SHA, skipping release"
          exit 0
        fi
        echo "Found tag: $TAG"

        if ! git branch -a --contains $COMMIT_SHA | grep -qE "(^|\s)${DEFAULT_BRANCH}$|origin/${DEFAULT_BRANCH}$"; then
          echo "Error: Tag must be on default branch (${DEFAULT_BRANCH})"
          exit 1
        fi

        echo "TAG=$TAG" >> $GITHUB_ENV

    - uses: actions/setup-node@v4
      if: env.TAG != ''
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - if: env.TAG != ''
      run: npm ci

    - name: build and release
      if: env.TAG != ''
      run: |
        npm run build
        npm run zip

    - name: create release
      if: env.TAG != ''
      uses: ncipollo/release-action@v1
      with:
        artifacts: "*.dist.zip"
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ env.TAG }}
